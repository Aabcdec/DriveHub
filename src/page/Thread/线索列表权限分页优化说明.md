# Thread/index.vue 线索列表权限分页优化说明

## 🎯 优化目标

为线索列表页面实现与campaigns.vue相同的权限分页逻辑，确保：
- **管理员**：可以看到所有线索数据的total
- **普通用户**：只能看到自己创建的线索数据的total

## ✅ 已完成的优化

### 1. 添加用户角色和ID字段
```javascript
data() {
  return {
    // 新增字段
    currentUserRole: '', // 当前用户角色
    currentUserId: '', // 当前用户ID
    // ... 其他字段
  }
}
```

### 2. 新增用户信息获取方法
```javascript
// 获取当前用户信息和角色
async getCurrentUserInfo() {
  try {
    // 从localStorage获取用户ID
    const tokenData = JSON.parse(localStorage.getItem("TOKEN"))
    if (tokenData && tokenData.value && tokenData.value.id) {
      this.currentUserId = tokenData.value.id
      
      // 获取用户角色信息
      const res = await doGet('/api/byIdClue', { id: this.currentUserId })
      if (res.data && res.data.role) {
        this.currentUserRole = res.data.role
      }
    }
  } catch (error) {
    console.error('获取用户信息失败:', error)
    this.currentUserRole = 'user' // 默认为普通用户
  }
}
```

### 3. 优化loadThreads方法 - 核心权限逻辑
```javascript
loadThreads() {
  this.loading = true
  const params = {
    pageNum: this.currentPage,
    pageSize: this.pageSize
  }

  doGet('/api/threads', params)
    .then(res => {
      if (res.data && res.status === 200) {
        this.threads = res.data || this.threads
         console.log(res)
        // 根据用户角色计算total
        if (this.currentUserRole === 'admin') {
          // 管理员可以看到所有数据
          this.total = res.data[0].total
          console.log('管理员模式：显示所有线索数据，总数:', this.total)
        } else {
          // 普通用户只能看到自己的数据
         
          this.total = res.data.length
          console.log('普通用户模式：只显示自己的线索数据，总数:', this.total)
          
          // 同时过滤显示的数据
          this.threads = userOwnThreads
        }
      }
    })
}
```

### 4. 优化searchThreads方法 - 搜索权限控制
```javascript
searchThreads() {
  // 权限检查：普通用户只能搜索自己的数据
  if (this.currentUserRole !== 'admin' && this.searchForm.createBy && 
      this.searchForm.createBy.toString() !== this.currentUserId.toString()) {
    ElMessage.warning('您只能查询自己的数据')
    return
  }

  doPost('/api/searchThread', this.searchForm)
    .then(res => {
      if (res.data.length >= 0) {
        let filteredData = res.data || []
        
        // 根据用户角色过滤搜索结果
        if (this.currentUserRole === 'admin') {
          // 管理员可以看到所有搜索结果
          this.threads = filteredData
          this.total = filteredData.length
        } else {
          // 普通用户只能看到自己的数据
          const userOwnData = filteredData.filter(thread => 
            thread.createBy && thread.createBy.toString() === this.currentUserId.toString()
          )
          this.threads = userOwnData
          this.total = userOwnData.length
        }
      }
    })
}
```

### 5. 优化resetSearch方法
```javascript
resetSearch() {
  this.searchForm = {
    fullName: '',
    source: '',
    state: '',
    createBy: ''
  }
  this.currentPage = 1
  // 重置后重新加载数据，这会触发权限逻辑来正确设置分页
  this.loadThreads()
}
```

### 6. 修改生命周期
```javascript
mounted() {
  // ... 其他初始化代码
  this.getCurrentUserInfo() // 首先获取用户信息
  this.loadThreads()
  this.loadFollowRecords()
}
```

## 🔐 权限逻辑说明

### 管理员权限 (admin)
- ✅ 可以查看所有线索数据
- ✅ total显示所有记录的数量
- ✅ 可以搜索任何负责人的数据
- ✅ 分页基于所有数据计算

### 普通用户权限 (非admin)
- ✅ 只能查看自己创建的线索数据
- ✅ total只显示自己的记录数量
- ✅ 只能搜索自己的数据，搜索其他人会提示权限不足
- ✅ 分页基于自己的数据计算
- ✅ 列表显示也会被过滤，只显示自己的线索

## 🎯 核心改进点

### 1. 数据过滤逻辑
- 在`loadThreads()`方法中根据用户角色过滤数据
- 管理员：显示所有数据，`this.total = res.data[0].total`
- 普通用户：过滤数据，`this.total = userOwnThreads.length`

### 2. 分页total计算
- 管理员：`this.total = 所有数据.total`
- 普通用户：`this.total = 自己的数据.length`

### 3. 搜索权限控制
- 普通用户尝试搜索其他人数据时显示警告
- 搜索结果的total也按权限计算

### 4. 数据显示过滤
- 普通用户不仅total被限制，显示的数据也被过滤
- 确保用户只能看到自己创建的线索

### 5. 控制台日志
- 添加详细的日志输出，便于调试和确认权限逻辑
- 可以清楚看到当前用户角色和数据过滤结果

## 🚀 使用效果

### 管理员登录时
- 看到所有线索记录
- 分页显示总记录数
- 可以搜索任何负责人的数据

### 普通用户登录时
- 只看到自己创建的线索记录
- 分页只显示自己的记录数
- 搜索时只能选择自己，选择其他人会提示权限不足
- 列表中只显示自己的线索

## 📝 注意事项

1. **不修改后端交互逻辑**：所有修改都在前端完成，不影响现有API调用
2. **保持现有功能**：所有原有功能保持不变，只是增加了权限控制
3. **向下兼容**：如果获取用户信息失败，默认为普通用户权限
4. **调试友好**：添加了详细的控制台日志，便于问题排查
5. **数据一致性**：确保显示的数据和分页total保持一致

## 🔧 技术实现要点

- 使用localStorage中的TOKEN获取用户ID
- 通过`/api/byIdClue`接口获取用户角色
- 在数据过滤时使用`toString()`确保ID比较的准确性
- 基于`createBy`字段进行权限过滤
- 在所有涉及分页的方法中都应用权限逻辑
- 保持搜索、重置、分页切换等功能的一致性

## 🆚 与campaigns.vue的区别

1. **过滤字段不同**：
   - campaigns.vue基于`ownerId`字段过滤
   - Thread/index.vue基于`createBy`字段过滤

2. **数据处理方式**：
   - campaigns.vue在getTotal()中过滤数据
   - Thread/index.vue在loadThreads()中直接过滤显示数据

3. **业务逻辑**：
   - 线索管理：用户只能管理自己创建的线索
   - 活动管理：用户只能管理自己负责的活动

现在您的线索列表页面已经具备了完善的权限分页功能，与campaigns.vue保持一致的权限控制逻辑！
