# 路由权限功能实现说明

## 📋 功能概述

实现了完整的路由权限判断功能，确保只有登录用户才能访问受保护的页面，未登录用户会被自动重定向到登录页面。

## 🔐 权限控制机制

### 1. 路由元信息配置
为每个路由添加了`meta`字段，标识是否需要登录权限：

```javascript
// 不需要权限的路由
{
  path: '/login',
  meta: { requiresAuth: false, title: '用户登录' }
}

// 需要权限的路由
{
  path: '/home',
  meta: { requiresAuth: true, title: '首页' }
}
```

### 2. 全局路由守卫
在`src/router/index.js`中实现了全局前置守卫：

```javascript
router.beforeEach((to, _from, next) => {
  const requiresAuth = to.matched.some(record => record.meta.requiresAuth)
  
  if (requiresAuth) {
    if (isAuthenticated()) {
      next() // 已登录，允许访问
    } else {
      // 未登录，重定向到登录页
      ElMessage.warning('请先登录')
      next({
        path: '/login',
        query: { redirect: to.fullPath }
      })
    }
  } else {
    // 不需要权限的路由
    if (to.path === '/login' && isAuthenticated()) {
      next('/home') // 已登录用户访问登录页，重定向到首页
    } else {
      next() // 允许访问
    }
  }
})
```

### 3. 身份验证检查
通过检查localStorage中的Token来判断用户是否已登录：

```javascript
function isAuthenticated() {
  const token = storageUtil.getItemWithExpire('TOKEN')
  return token && token.token
}
```

## 🚀 核心功能

### 1. 登录状态检查
- **Token验证**: 检查localStorage中是否存在有效Token
- **过期检查**: 自动检查Token是否过期
- **自动清理**: 过期Token会被自动清除

### 2. 路由拦截
- **权限路由**: 需要登录才能访问的页面
- **公开路由**: 不需要登录的页面（登录、注册）
- **智能重定向**: 已登录用户访问登录页会重定向到首页

### 3. 登录重定向
- **保存原路径**: 未登录访问受保护页面时，保存原始路径
- **登录后跳转**: 登录成功后自动跳转到原始访问路径
- **默认跳转**: 直接登录时跳转到首页

### 4. 退出登录
- **确认对话框**: 退出前显示确认对话框
- **清除Token**: 清除本地存储的用户信息
- **跳转登录页**: 退出后自动跳转到登录页

## 📁 涉及的文件

### 1. 路由配置 (`src/router/index.js`)
- 添加路由元信息
- 实现全局路由守卫
- 配置页面标题

### 2. 登录页面 (`src/page/Login/index.vue`)
- 登录成功后的重定向逻辑
- 检查query参数中的redirect路径

### 3. 首页 (`src/page/Home/index.vue`)
- 添加退出登录功能
- 用户下拉菜单操作

### 4. Token工具 (`src/util/Token.js`)
- Token存储和获取
- 过期时间检查
- 自动清理功能

## 🎯 路由权限配置

### 公开路由（不需要登录）
- `/` - 根路径（重定向到登录页）
- `/login` - 登录页面
- `/register` - 注册页面
- `/packImg` - 背景图片设置
- `/backTheme` - 主题设置

### 受保护路由（需要登录）
- `/home` - 首页及所有子路由
- `/market/*` - 市场管理模块
- `/thread/*` - 线索管理模块
- `/clientMana/*` - 客户管理模块
- `/transaction/*` - 交易管理模块
- `/product/*` - 产品管理模块
- `/dictionary/*` - 字典管理模块
- `/users/*` - 用户管理模块
- `/system/*` - 系统管理模块

## 🔄 用户流程

### 1. 未登录用户访问流程
```
用户访问受保护页面 → 检查登录状态 → 未登录 → 显示警告 → 重定向到登录页 → 保存原路径
```

### 2. 登录成功流程
```
用户登录 → 验证成功 → 存储Token → 检查重定向路径 → 跳转到目标页面
```

### 3. 已登录用户流程
```
用户访问页面 → 检查登录状态 → 已登录 → 允许访问 → 更新页面标题
```

### 4. 退出登录流程
```
用户点击退出 → 显示确认对话框 → 确认退出 → 清除Token → 跳转登录页
```

## 🛡️ 安全特性

### 1. Token管理
- **过期机制**: Token支持过期时间设置
- **自动清理**: 过期Token自动清除
- **安全存储**: 使用localStorage安全存储

### 2. 路由保护
- **全面覆盖**: 所有业务页面都受保护
- **智能判断**: 根据路由元信息自动判断权限
- **防止绕过**: 前端路由完全拦截

### 3. 用户体验
- **友好提示**: 未登录时显示友好提示
- **无缝跳转**: 登录后自动跳转到原页面
- **状态保持**: 登录状态在页面刷新后保持

## 🧪 测试场景

### 1. 权限测试
- **未登录访问**: 直接访问 http://localhost:8081/home
- **登录后访问**: 登录后访问各个业务页面
- **退出登录**: 测试退出登录功能

### 2. 重定向测试
- **保存路径**: 未登录访问 `/market`，登录后应跳转到市场页面
- **默认跳转**: 直接登录应跳转到首页
- **已登录重定向**: 已登录访问登录页应跳转到首页

### 3. Token测试
- **过期处理**: 等待Token过期后访问页面
- **手动清除**: 手动清除localStorage后访问页面
- **刷新保持**: 页面刷新后登录状态保持

## 🌐 访问地址

- **本地访问**: http://localhost:8081/
- **网络访问**: http://172.25.219.212:8081/

## 💡 使用建议

1. **开发测试**: 可以通过浏览器开发者工具清除localStorage来测试未登录状态
2. **Token过期**: 可以修改Token.js中的过期时间来测试过期机制
3. **路由测试**: 直接在地址栏输入受保护的路由地址来测试拦截功能
4. **用户体验**: 注意观察各种场景下的提示信息和跳转逻辑

路由权限功能现已完全实现，提供了完整的身份验证和访问控制机制，确保系统的安全性和用户体验。
